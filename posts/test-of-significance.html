<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confidence Level Calculator</title>
    <style>
        body {
            font-family: monospace;
            max-width: 500px;
            margin: 20px auto;
            padding: 20px;
            background-color: white;
            color: #000;
        }
        h1 {
            font-size: 18px;
            font-weight: normal;
            margin-bottom: 30px;
            text-align: left;
        }
        .inputs {
            margin-bottom: 20px;
        }
        .row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .field {
            flex: 1;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }
        input[type="number"] {
            width: 100%;
            padding: 5px;
            border: 1px solid #000;
            font-family: monospace;
            font-size: 14px;
            background: white;
            -moz-appearance: textfield; /* Firefox */
        }
        /* Remove spinner arrows in Chrome, Safari, Edge */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"]:focus {
            outline: 1px solid #000;
            outline-offset: 1px;
        }
        button {
            padding: 8px 16px;
            background-color: #000;
            color: #fff;
            border: none;
            font-family: monospace;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #333;
        }
        .result {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #000;
            display: none;
        }
        .result.show {
            display: block;
        }
        .confidence-value {
            font-size: 24px;
            margin: 10px 0;
        }
        .proportions {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }
        .error {
            color: #000;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }
        .note {
            margin-top: 40px;
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <h1>Two-Proportion Confidence Level Calculator</h1>
    
    <div class="inputs">
        <div class="row">
            <div class="field">
                <label for="n1">N₁ (Total, Group 1)</label>
                <input type="number" id="n1" min="1" step="1">
            </div>
            <div class="field">
                <label for="k1">K₁ (Successes, Group 1)</label>
                <input type="number" id="k1" min="0" step="1">
            </div>
        </div>
        
        <div class="row">
            <div class="field">
                <label for="n2">N₂ (Total, Group 2)</label>
                <input type="number" id="n2" min="1" step="1">
            </div>
            <div class="field">
                <label for="k2">K₂ (Successes, Group 2)</label>
                <input type="number" id="k2" min="0" step="1">
            </div>
        </div>
    </div>
    
    <button onclick="calculateConfidence()">Calculate</button>
    
    <div class="error" id="error-message"></div>
    
    <div class="result" id="result">
        <div>Confidence Level</div>
        <div class="confidence-value" id="confidence-value"></div>
        <div class="proportions">
            p₁ = <span id="p1"></span>, p₂ = <span id="p2"></span>
        </div>
    </div>
    
    <div class="note">
        Two-proportion z-test. Enter total observations (N) and successes (K) for each group.
    </div>

    <div class="note">
        E.g. Suppose you have two cohorts - In the first cohort, 1000 clicked and 100 purchased.
        In other cohort, 2000 clicked and 210 purchased. How confident can you be that second
        cohort outperformed first cohort due to a systemic improvement, rather than just the noise?
        You enter N1 = 1000, K1 = 100, N2 = 2000, K2 = 210.
    </div>
    <div class="note">
        We should strive for 80% confidence in concluding our experiments.
    </div>

    <script>
        function erf(x) {
            const a1 =  0.254829592;
            const a2 = -0.284496736;
            const a3 =  1.421413741;
            const a4 = -1.453152027;
            const a5 =  1.061405429;
            const p  =  0.3275911;

            const sign = x >= 0 ? 1 : -1;
            x = Math.abs(x);

            const t = 1.0 / (1.0 + p * x);
            const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);

            return sign * y;
        }

        function normalCDF(z) {
            return 0.5 * (1 + erf(z / Math.sqrt(2)));
        }

        function confidenceLevelPercent(N1, K1, N2, K2) {
            const p1_hat = K1 / N1;
            const p2_hat = K2 / N2;
            const p_pooled = (K1 + K2) / (N1 + N2);
            const se = Math.sqrt(p_pooled * (1 - p_pooled) * (1/N1 + 1/N2));
            
            if (se === 0) {
                return p1_hat === p2_hat ? 0.0 : 100.0;
            }
            
            const z = (p1_hat - p2_hat) / se;
            const p_value = 2 * (1 - normalCDF(Math.abs(z)));
            const confidence = (1 - p_value) * 100;
            
            return {
                confidence: confidence,
                p1: p1_hat,
                p2: p2_hat
            };
        }

        function calculateConfidence() {
            const errorDiv = document.getElementById('error-message');
            const resultDiv = document.getElementById('result');
            errorDiv.style.display = 'none';
            resultDiv.classList.remove('show');
            
            const n1 = parseInt(document.getElementById('n1').value);
            const k1 = parseInt(document.getElementById('k1').value);
            const n2 = parseInt(document.getElementById('n2').value);
            const k2 = parseInt(document.getElementById('k2').value);
            
            if (isNaN(n1) || isNaN(k1) || isNaN(n2) || isNaN(k2)) {
                errorDiv.textContent = 'Enter valid numbers for all fields.';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (n1 <= 0 || n2 <= 0) {
                errorDiv.textContent = 'N₁ and N₂ must be > 0.';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (k1 < 0 || k2 < 0) {
                errorDiv.textContent = 'K₁ and K₂ must be ≥ 0.';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (k1 > n1 || k2 > n2) {
                errorDiv.textContent = 'Successes cannot exceed total.';
                errorDiv.style.display = 'block';
                return;
            }
            
            const result = confidenceLevelPercent(n1, k1, n2, k2);
            
            document.getElementById('confidence-value').textContent = result.confidence.toFixed(2) + '%';
            document.getElementById('p1').textContent = result.p1.toFixed(4);
            document.getElementById('p2').textContent = result.p2.toFixed(4);
            resultDiv.classList.add('show');
        }

        document.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                calculateConfidence();
            }
        });
    </script>
</body>
</html>
